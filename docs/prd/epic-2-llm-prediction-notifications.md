# Epic 2: LLM 기반 예측 및 알림 시스템

### Epic 목표

Epic 1에서 구축한 데이터 인프라를 기반으로 실제 투자자에게 가치를 제공하는 예측 및 알림 시스템을 완성합니다. 새로운 뉴스가 발생하면 Milvus에서 유사한 과거 뉴스를 검색하고, LLM이 이를 종합 분석하여 상승/하락 확률과 예측 근거를 생성합니다. 시간대를 자동 판별하여 맞춤 전략 메시지를 작성하고, 영향도 8.0 이상인 경우 텔레그램으로 즉시 알림을 전송합니다. Epic 완료 시, 뉴스 발생부터 텔레그램 알림까지 5분 이내 end-to-end 파이프라인이 완전히 작동합니다.

---

### Story 2.1: 벡터 유사도 검색 구현

**As a** 시스템,
**I want** 새로운 뉴스의 임베딩을 생성하고 Milvus에서 유사한 과거 뉴스 TOP 5를 검색하여,
**so that** LLM이 과거 패턴을 참조할 수 있다.

#### Acceptance Criteria

1. 유사도 검색 함수(`backend/llm/similarity_search.py`)가 구현된다.
2. 입력: 뉴스 텍스트, 출력: 유사 뉴스 TOP 5 (news_id, 유사도, 제목, 종목코드, 변동률)
3. OpenAI text-embedding-3-small로 입력 뉴스를 임베딩한다.
4. Milvus에서 L2 거리 기반 유사도 검색을 수행한다.
5. 검색 결과에서 PostgreSQL과 조인하여 상세 정보를 가져온다.
6. 검색 시간이 100ms 이내로 완료된다.
7. 로컬 테스트: 유사한 뉴스들이 정확히 반환된다.

---

### Story 2.2: LLM 프롬프트 설계 및 RAG 분석 로직

**As a** 시스템,
**I want** 현재 뉴스, 유사 과거 뉴스, 현재 주가를 LLM에 제공하여 종합 분석 결과를 받아,
**so that** 상승/하락 확률 및 예측 근거를 생성할 수 있다.

#### Acceptance Criteria

1. LLM 분석 함수(`backend/llm/predictor.py`)가 구현된다.
2. 입력: 현재 뉴스, 유사 뉴스 TOP 5, 현재 주가 정보
3. LLM 프롬프트가 체계적으로 구성된다 (역할, 현재 뉴스, 과거 유사 뉴스, 질문)
4. OpenAI GPT-4o-mini API를 호출하여 JSON 형식 응답을 받는다.
5. 응답 파싱 후 예측 결과 객체로 반환한다.
6. LLM 응답 시간이 2~5초 이내이다.
7. API 비용이 1건당 $0.02 이하로 유지된다.
8. 로컬 테스트: 실제 뉴스로 유효한 JSON 응답이 반환된다.

---

### Story 2.3: 시간대 판별 로직 구현

**As a** 시스템,
**I want** 뉴스 발표 시간을 기준으로 프리마켓/장중/장후를 자동 판별하여,
**so that** 시간대별 맞춤 전략을 제공할 수 있다.

#### Acceptance Criteria

1. 시간대 판별 함수(`backend/llm/time_classifier.py`)가 구현된다.
2. 입력: 뉴스 발표 시간, 출력: "PRE_MARKET" | "INTRADAY" | "POST_MARKET"
3. 판별 기준:
   - PRE_MARKET: 00:00 ~ 08:59
   - INTRADAY: 09:00 ~ 15:29
   - POST_MARKET: 15:30 ~ 23:59
4. 주말/공휴일은 POST_MARKET으로 처리한다.
5. 한국 시간대(KST) 기준으로 판별한다.
6. 로컬 테스트: 다양한 시간대 입력 시 올바른 분류가 반환된다.

---

### Story 2.4: 시간대별 메시지 생성 템플릿

**As a** 시스템,
**I want** 시간대에 따라 다른 구조의 텔레그램 메시지를 생성하여,
**so that** 사용자에게 상황별 최적의 투자 전략을 제공할 수 있다.

#### Acceptance Criteria

1. 메시지 생성 함수(`backend/telegram/message_builder.py`)가 구현된다.
2. 입력: 예측 결과, 시간대, 뉴스 정보, 주가 정보
3. 프리마켓 템플릿이 예상 시가, 동시호가 전략, 과거 패턴, 전략 옵션을 포함한다.
4. 장중 템플릿이 현재가, 뉴스 반영도(%), 추가 상승 여력, 진입 타이밍을 포함한다.
5. 장후 템플릿이 다음날 예상 시가, 준비 사항, 목표가/손절가를 포함한다.
6. 모든 메시지는 텔레그램 마크다운 포맷을 사용한다.
7. 이모지 사용 규칙을 준수한다.
8. 메시지 길이가 500~800자 범위로 제한된다.
9. 메시지 끝에 면책 조항이 포함된다.
10. 로컬 테스트: 각 시간대별 샘플 데이터로 올바른 포맷이 반환된다.

---

### Story 2.5: 영향도 필터링 및 알림 트리거 로직

**As a** 시스템,
**I want** LLM 예측 결과 중 영향도 8.0 이상인 뉴스만 알림 대상으로 선정하여,
**so that** 중요한 뉴스만 사용자에게 전달하고 알림 피로도를 방지할 수 있다.

#### Acceptance Criteria

1. 알림 트리거 함수(`backend/telegram/notification_filter.py`)가 구현된다.
2. 입력: LLM 예측 결과, 출력: True(알림 전송) | False(전송 안 함)
3. 필터링 기준:
   - 영향도 점수 ≥ 8.0
   - 상승 또는 하락 확률 ≥ 70%
4. 동일 종목에 대해 1시간 내 중복 알림을 방지한다 (Redis 캐시).
5. 필터링 로그를 기록한다.
6. 로컬 테스트: 영향도 7.5는 필터링, 8.5는 통과한다.

---

### Story 2.6: 텔레그램 봇 기본 구현

**As a** 사용자,
**I want** 텔레그램에서 봇을 추가하고 `/start` 명령으로 구독을 시작하여,
**so that** 중요 뉴스 알림을 받을 수 있다.

#### Acceptance Criteria

1. 텔레그램 봇(`backend/telegram/bot.py`)이 python-telegram-bot으로 구현된다.
2. 봇 토큰은 환경 변수에서 로드한다.
3. `/start` 명령 처리: user_id를 DB에 저장하고 환영 메시지 전송
4. `/stop` 명령 처리: is_active를 false로 업데이트
5. `/help` 명령 처리: 사용 가능한 명령어 안내
6. 봇이 FastAPI와 별도 프로세스로 실행된다.
7. 로컬 테스트: 텔레그램에서 `/start` 실행 → 환영 메시지 수신

---

### Story 2.7: 비동기 알림 파이프라인 구현

**As a** 시스템,
**I want** 새 뉴스 감지 시 예측 분석부터 텔레그램 전송까지 비동기로 처리하여,
**so that** 5분 이내 알림을 보낼 수 있다.

#### Acceptance Criteria

1. 뉴스 감지 트리거가 10분마다 실행되며 새 뉴스를 확인한다.
2. 새 뉴스 발견 시 Celery 태스크를 큐에 추가한다.
3. Celery 워커가 순차 실행한다:
   - 벡터 유사도 검색
   - LLM 예측 분석
   - 시간대 판별
   - 메시지 생성
   - 영향도 필터링
   - 텔레그램 전송
4. 전체 파이프라인이 평균 3분 이내 완료된다.
5. 각 단계의 실행 시간을 로그로 기록한다.
6. 에러 발생 시 Celery 재시도 정책이 작동한다 (최대 3회).
7. 로컬 테스트: 새 뉴스 삽입 → 5분 이내 텔레그램 알림 수신

---

### Story 2.8: End-to-End 통합 테스트 및 모니터링

**As a** 개발자/운영자,
**I want** 전체 시스템의 end-to-end 통합 테스트를 수행하고 모니터링 대시보드를 확인하여,
**so that** MVP가 요구사항을 충족하는지 검증할 수 있다.

#### Acceptance Criteria

1. E2E 테스트 스크립트(`tests/e2e_test.py`)가 제공된다.
2. 테스트 시나리오: 뉴스 크롤링 → 주가 수집 → 매칭 → 임베딩 → 예측 → 알림
3. 각 단계의 성공/실패를 로그로 기록한다.
4. 헬스체크 API를 확장하여 last_prediction, telegram_notifications_sent_24h, average_prediction_time 추가
5. 모니터링 엔드포인트 `GET /metrics` 구현
6. 2주 MVP 기간 동안:
   - 데이터 수집 성공률 ≥ 95%
   - 예측 → 알림 시간 평균 ≤ 5분
   - 텔레그램 전송 성공률 ≥ 95%
7. 테스트 사용자 20명 이상 `/start` 구독 완료
8. 실제 중요 뉴스 10건 이상에 대해 알림이 정상 전송됨
9. 사용자 피드백 수집 방법이 문서화됨
