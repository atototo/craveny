# Story 2.2: llm-prompt-rag

**Epic:** 2 - LLM 기반 예측 및 알림 시스템
**Status:** Draft

---

## Story

**As a** 시스템,
**I want** 현재 뉴스, 유사 과거 뉴스, 현재 주가를 LLM에 제공하여 종합 분석 결과를 받아,
**so that** 상승/하락 확률 및 예측 근거를 생성할 수 있다.

---

## Acceptance Criteria

1. LLM 분석 함수(`backend/llm/predictor.py`)가 구현된다.
2. 입력: 현재 뉴스, 유사 뉴스 TOP 5, 현재 주가 정보
3. LLM 프롬프트가 체계적으로 구성된다 (역할, 현재 뉴스, 과거 유사 뉴스, 질문)
4. OpenAI GPT-4o-mini API를 호출하여 JSON 형식 응답을 받는다.
5. 응답 파싱 후 예측 결과 객체로 반환한다.
6. LLM 응답 시간이 2~5초 이내이다.
7. API 비용이 1건당 $0.02 이하로 유지된다.
8. 로컬 테스트: 실제 뉴스로 유효한 JSON 응답이 반환된다.

---

## Tasks / Subtasks

- [ ] Task 1: 프롬프트 템플릿 작성 (AC: 3)
  - [ ] `backend/llm/prompts/prediction_prompt.py` 생성
  - [ ] 시스템 역할 정의
  - [ ] 현재 뉴스 섹션
  - [ ] 과거 유사 뉴스 섹션
  - [ ] 질문 및 출력 형식

- [ ] Task 2: LLM 예측 함수 (AC: 1, 2)
  - [ ] `backend/llm/predictor.py` 작성
  - [ ] predict_news_impact() 함수
  - [ ] 입력: 뉴스, 유사 뉴스, 주가
  - [ ] 출력: PredictionResult Pydantic 모델

- [ ] Task 3: OpenAI API 호출 (AC: 4, 6)
  - [ ] GPT-4o-mini 사용
  - [ ] JSON mode 활성화
  - [ ] temperature=0.3 (일관성)
  - [ ] max_tokens=500

- [ ] Task 4: JSON 응답 파싱 (AC: 5)
  - [ ] Pydantic 모델 검증
  - [ ] 에러 처리

- [ ] Task 5: 비용 모니터링 (AC: 7)
  - [ ] 토큰 사용량 로그
  - [ ] 비용 계산 ($0.01/1K tokens)

- [ ] Task 6: 테스트 (AC: 8)
  - [ ] 샘플 뉴스 예측
  - [ ] JSON 응답 검증
  - [ ] 응답 시간 측정

---

## Dev Notes

### Prompt Template

```python
SYSTEM_ROLE = """
당신은 한국 증권시장 전문 애널리스트입니다. 뉴스와 과거 패턴을 분석하여 주가 영향도를 예측합니다.
"""

USER_PROMPT = """
# 현재 뉴스
제목: {title}
본문: {content}
종목: {stock_code}
현재가: {current_price}원

# 과거 유사 뉴스 (TOP 5)
{similar_news_list}

# 질문
위 정보를 종합하여 다음을 JSON 형식으로 예측해주세요:
{{
  "predicted_direction": "UP" | "DOWN" | "NEUTRAL",
  "confidence_score": 0.0-1.0,
  "impact_score": 0.0-10.0,
  "expected_change_pct": float,
  "impact_duration_days": int,
  "reasoning": "예측 근거"
}}
"""
```

### PredictionResult Model

```python
from pydantic import BaseModel, Field

class PredictionResult(BaseModel):
    predicted_direction: Literal["UP", "DOWN", "NEUTRAL"]
    confidence_score: float = Field(ge=0.0, le=1.0)
    impact_score: float = Field(ge=0.0, le=10.0)
    expected_change_pct: float
    impact_duration_days: int
    reasoning: str
```

### Testing

**Test Cases:**
1. GPT-4o-mini 호출 성공
2. JSON 응답 파싱
3. Pydantic 검증
4. 응답 시간 2-5초
5. 비용 <$0.02

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-31 | 1.0 | Story created from Epic 2 | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used

_To be populated by Dev Agent_

### Debug Log References

_To be populated by Dev Agent_

### Completion Notes List

_To be populated by Dev Agent_

### File List

_To be populated by Dev Agent_

---

## QA Results

_To be populated by QA Agent_
