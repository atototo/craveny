# Story 1.6: news-stock-matching

**Epic:** 1 - 데이터 수집 및 저장 인프라
**Status:** Draft

---

## Story

**As a** 시스템,
**I want** 뉴스 발표 후 1일/3일/5일 주가 변동률을 자동 계산하여 저장하고,
**so that** LLM이 과거 패턴을 참조할 수 있다.

---

## Acceptance Criteria

1. 매칭 스크립트(`backend/crawlers/news_stock_matcher.py`)가 매일 장 마감 후(15:40) 실행된다.
2. 각 뉴스에 대해 발표 시점 주가(T0)와 T+1일, T+3일, T+5일 종가를 조회한다.
3. 변동률 = ((T+N일 종가 - T0 주가) / T0 주가) * 100으로 계산한다.
4. 계산된 변동률을 `news_stock_match` 테이블에 저장한다.
5. 주말/공휴일은 다음 영업일 종가를 사용한다.
6. 매칭 정확도가 90% 이상이다.
7. 로컬 테스트: 특정 뉴스의 변동률이 정확히 계산된다.

---

## Tasks / Subtasks

- [ ] Task 1: 영업일 계산 유틸리티 (AC: 5)
  - [ ] `backend/utils/business_days.py` 작성
  - [ ] get_next_business_day() 함수
  - [ ] 공휴일 데이터 통합 (선택사항)

- [ ] Task 2: 주가 조회 로직 (AC: 2)
  - [ ] 뉴스 발표 시점 주가 조회
  - [ ] T+1, T+3, T+5일 종가 조회
  - [ ] stock_prices 테이블 쿼리

- [ ] Task 3: 변동률 계산 (AC: 3)
  - [ ] calculate_price_change() 함수
  - [ ] 퍼센티지 계산 및 반올림

- [ ] Task 4: 매칭 데이터 저장 (AC: 4)
  - [ ] NewsStockMatch 모델 인스턴스 생성
  - [ ] DB 커밋

- [ ] Task 5: APScheduler 통합 (AC: 1)
  - [ ] CronTrigger (매일 15:40)
  - [ ] 스케줄러에 작업 등록

- [ ] Task 6: 테스트 (AC: 6, 7)
  - [ ] 샘플 뉴스 변동률 계산
  - [ ] 정확도 검증

---

## Dev Notes

### Price Change Calculation

```python
def calculate_price_change(t0_price: float, tn_price: float) -> float:
    if t0_price == 0:
        return 0.0
    return round(((tn_price - t0_price) / t0_price) * 100, 2)
```

### Business Day Logic

- 주말 skip (토, 일)
- 공휴일 skip (추후 확장)
- pandas.bdate_range 활용 가능

### Testing

**Test Cases:**
1. T+1일 변동률 계산
2. 주말 건너뛰기
3. 매칭 정확도 90% 검증

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-31 | 1.0 | Story created from Epic 1 | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used

_To be populated by Dev Agent_

### Debug Log References

_To be populated by Dev Agent_

### Completion Notes List

_To be populated by Dev Agent_

### File List

_To be populated by Dev Agent_

---

## QA Results

_To be populated by QA Agent_
