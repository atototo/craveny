# Story 1.9: healthcheck-api

**Epic:** 1 - 데이터 수집 및 저장 인프라
**Status:** Draft

---

## Story

**As a** 개발자/운영자,
**I want** 시스템 상태를 확인할 수 있는 헬스체크 API를 제공받아,
**so that** 데이터 수집 파이프라인이 정상 작동 중인지 모니터링할 수 있다.

---

## Acceptance Criteria

1. FastAPI 헬스체크 엔드포인트 `GET /health`가 구현된다.
2. 응답은 다음 정보를 JSON으로 반환한다:
   - `status`: "healthy" 또는 "unhealthy"
   - `postgres`: 연결 상태 (true/false)
   - `milvus`: 연결 상태 (true/false)
   - `redis`: 연결 상태 (true/false)
   - `news_count`: PostgreSQL 뉴스 건수
   - `vector_count`: Milvus 벡터 건수
   - `last_news_collected`: 마지막 뉴스 수집 시간
3. 모든 서비스 정상이면 HTTP 200, 문제 있으면 HTTP 503 반환.
4. FastAPI 서버가 포트 8000에서 실행되며, `http://localhost:8000/health`로 접근 가능하다.
5. 로컬 테스트: 헬스체크 API 호출 시 정상 응답 반환.

---

## Tasks / Subtasks

- [ ] Task 1: FastAPI 라우터 생성 (AC: 1)
  - [ ] `backend/api/__init__.py` 생성
  - [ ] `backend/api/health.py` 작성
  - [ ] APIRouter 정의

- [ ] Task 2: 서비스 연결 체크 함수 (AC: 2, 3)
  - [ ] check_postgres() - DB 쿼리 실행
  - [ ] check_milvus() - 컬렉션 존재 확인
  - [ ] check_redis() - PING 명령

- [ ] Task 3: 통계 정보 조회 (AC: 2)
  - [ ] PostgreSQL 뉴스 건수 (COUNT)
  - [ ] Milvus 벡터 건수 (collection.num_entities)
  - [ ] 마지막 뉴스 수집 시간 (MAX created_at)

- [ ] Task 4: HTTP 상태 코드 처리 (AC: 3)
  - [ ] 모든 서비스 정상: 200 OK
  - [ ] 하나라도 문제: 503 Service Unavailable

- [ ] Task 5: FastAPI main에 라우터 등록 (AC: 4)
  - [ ] `backend/main.py`에 health router 추가
  - [ ] app.include_router(health.router)

- [ ] Task 6: 테스트 (AC: 5)
  - [ ] curl로 헬스체크 호출
  - [ ] JSON 응답 검증

---

## Dev Notes

### Health Check Response

```json
{
  "status": "healthy",
  "postgres": true,
  "milvus": true,
  "redis": true,
  "news_count": 523,
  "vector_count": 523,
  "last_news_collected": "2025-10-31T14:30:00Z"
}
```

### Implementation

```python
# backend/api/health.py

from fastapi import APIRouter, status
from fastapi.responses import JSONResponse

router = APIRouter()

@router.get("/health")
async def health_check():
    try:
        pg_ok = await check_postgres()
        mv_ok = await check_milvus()
        rd_ok = await check_redis()

        if pg_ok and mv_ok and rd_ok:
            return JSONResponse(
                status_code=status.HTTP_200_OK,
                content={
                    "status": "healthy",
                    "postgres": True,
                    "milvus": True,
                    "redis": True,
                    "news_count": await get_news_count(),
                    "vector_count": await get_vector_count(),
                    "last_news_collected": await get_last_news_time(),
                }
            )
        else:
            return JSONResponse(
                status_code=status.HTTP_503_SERVICE_UNAVAILABLE,
                content={
                    "status": "unhealthy",
                    "postgres": pg_ok,
                    "milvus": mv_ok,
                    "redis": rd_ok,
                }
            )
    except Exception as e:
        return JSONResponse(
            status_code=status.HTTP_503_SERVICE_UNAVAILABLE,
            content={"status": "error", "message": str(e)}
        )
```

### Testing

**Test Location**: `tests/integration/test_health_api.py`

**Test Cases:**
1. 모든 서비스 정상 → 200 OK
2. PostgreSQL 연결 실패 → 503
3. Milvus 연결 실패 → 503
4. JSON 응답 스키마 검증

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-31 | 1.0 | Story created from Epic 1 | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used

_To be populated by Dev Agent_

### Debug Log References

_To be populated by Dev Agent_

### Completion Notes List

_To be populated by Dev Agent_

### File List

_To be populated by Dev Agent_

---

## QA Results

_To be populated by QA Agent_
