# Story 1.3: milvus-setup

**Epic:** 1 - 데이터 수집 및 저장 인프라
**Status:** Draft

---

## Story

**As a** 시스템,
**I want** Milvus 벡터 DB를 Docker로 실행하고 뉴스 임베딩 컬렉션을 생성하여,
**so that** 과거 유사 뉴스를 빠르게 검색할 수 있다.

---

## Acceptance Criteria

1. Milvus가 Docker Compose의 일부로 포트 19530에서 실행된다.
2. `news_embeddings` 컬렉션이 생성되며, 필드는 id(INT64, PK, auto_id), news_id(INT64), embedding(FLOAT_VECTOR, dim=768), stock_code(VARCHAR), price_change_1d(FLOAT), price_change_3d(FLOAT), price_change_5d(FLOAT)를 포함한다.
3. 인덱스가 embedding 필드에 생성된다 (metric_type: L2, index_type: IVF_FLAT).
4. Python 스크립트(`scripts/init_milvus.py`)로 컬렉션 생성 및 인덱스 구축이 자동화된다.
5. 로컬 테스트: 샘플 벡터 삽입 및 유사도 검색(TOP 5)이 성공한다.
6. Milvus 연결 헬퍼 함수(`backend/db/milvus_client.py`)가 제공된다.

---

## Tasks / Subtasks

- [ ] Task 1: Milvus 연결 클라이언트 작성 (AC: 6)
  - [ ] `backend/db/milvus_client.py` 생성
  - [ ] `connect_milvus()` 함수 - Milvus 연결
  - [ ] `disconnect_milvus()` 함수 - 연결 해제
  - [ ] `get_collection()` 함수 - 컬렉션 객체 반환
  - [ ] 환경 변수에서 MILVUS_HOST, MILVUS_PORT 로드

- [ ] Task 2: 컬렉션 스키마 정의 (AC: 2)
  - [ ] FieldSchema 정의
    - news_article_id (INT64, primary key, auto_id=False)
    - embedding (FLOAT_VECTOR, dim=768)
    - stock_code (VARCHAR, max_length=10)
    - published_timestamp (INT64)
  - [ ] CollectionSchema 생성
  - [ ] 컬렉션 description 추가

- [ ] Task 3: 인덱스 생성 (AC: 3)
  - [ ] IVF_FLAT 인덱스 파라미터 설정
    - index_type: "IVF_FLAT"
    - metric_type: "L2"
    - params: {"nlist": 128}
  - [ ] create_index() 호출
  - [ ] 컬렉션 load() 호출

- [ ] Task 4: Milvus 초기화 스크립트 (AC: 4)
  - [ ] `scripts/init_milvus.py` 작성
  - [ ] 기존 컬렉션 존재 시 삭제 옵션
  - [ ] 컬렉션 생성
  - [ ] 인덱스 구축
  - [ ] 성공/실패 로그 출력

- [ ] Task 5: 샘플 벡터 테스트 (AC: 5)
  - [ ] 테스트 벡터 3개 생성 (랜덤 768차원)
  - [ ] insert() 호출
  - [ ] search() 호출 (TOP 5)
  - [ ] 검색 결과 검증

---

## Dev Notes

### Milvus Architecture

**Collection Schema:**
```python
from pymilvus import FieldSchema, CollectionSchema, DataType

fields = [
    FieldSchema(name="news_article_id", dtype=DataType.INT64, is_primary=True, auto_id=False),
    FieldSchema(name="embedding", dtype=DataType.FLOAT_VECTOR, dim=768),
    FieldSchema(name="stock_code", dtype=DataType.VARCHAR, max_length=10),
    FieldSchema(name="published_timestamp", dtype=DataType.INT64),
]

schema = CollectionSchema(fields, description="뉴스 임베딩 컬렉션 (RAG용)")
```

**Index Configuration:**
- **IVF_FLAT**: 정확도 우선, 속도 보통
- **nlist=128**: 클러스터 수 (권장: sqrt(N), N=벡터 수)
- **L2 metric**: 유클리드 거리 기반 유사도
- **검색 시 nprobe=10**: 탐색 클러스터 수

**Performance Target:**
- 검색 시간: <100ms (500건 기준)
- 삽입 시간: <50ms/batch (100건)

### Milvus Connection Management

```python
from pymilvus import connections, Collection, utility

# 연결
connections.connect(
    alias="default",
    host=settings.MILVUS_HOST,
    port=settings.MILVUS_PORT,
)

# 컬렉션 로드
collection = Collection("news_embeddings")
collection.load()

# 연결 해제
connections.disconnect("default")
```

### Error Handling

- **ConnectionError**: Milvus 서비스 미실행 → Docker Compose 확인
- **CollectionNotExistException**: 컬렉션 미생성 → init_milvus.py 실행
- **DimensionMismatch**: 임베딩 차원 불일치 → 768 확인
- **IndexNotExistException**: 인덱스 미생성 → create_index() 호출

### Testing

**Test Location**: `tests/integration/test_milvus.py`

**Testing Requirements:**
- Milvus 연결 성공 여부
- 컬렉션 생성 및 스키마 검증
- 인덱스 생성 확인
- 벡터 삽입 및 검색 (TOP 5)
- 검색 결과 거리(distance) 검증

**Test Cases:**
1. Milvus 서비스 연결 성공
2. 컬렉션 존재 여부 확인
3. 샘플 벡터 3개 삽입
4. 유사도 검색 (TOP 5) - 결과 3개 반환
5. 검색 거리 오름차순 정렬 확인

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-31 | 1.0 | Story created from Epic 1 | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used

_To be populated by Dev Agent_

### Debug Log References

_To be populated by Dev Agent_

### Completion Notes List

_To be populated by Dev Agent_

### File List

_To be populated by Dev Agent_

---

## QA Results

_To be populated by QA Agent_
