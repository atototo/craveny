# Story 2.8: e2e-testing-monitoring

**Epic:** 2 - LLM 기반 예측 및 알림 시스템
**Status:** Draft

---

## Story

**As a** 개발자/운영자,
**I want** 전체 시스템의 end-to-end 통합 테스트를 수행하고 모니터링 대시보드를 확인하여,
**so that** MVP가 요구사항을 충족하는지 검증할 수 있다.

---

## Acceptance Criteria

1. E2E 테스트 스크립트(`tests/e2e_test.py`)가 제공된다.
2. 테스트 시나리오: 뉴스 크롤링 → 주가 수집 → 매칭 → 임베딩 → 예측 → 알림
3. 각 단계의 성공/실패를 로그로 기록한다.
4. 헬스체크 API를 확장하여 last_prediction, telegram_notifications_sent_24h, average_prediction_time 추가
5. 모니터링 엔드포인트 `GET /metrics` 구현
6. 2주 MVP 기간 동안:
   - 데이터 수집 성공률 ≥ 95%
   - 예측 → 알림 시간 평균 ≤ 5분
   - 텔레그램 전송 성공률 ≥ 95%
7. 테스트 사용자 20명 이상 `/start` 구독 완료
8. 실제 중요 뉴스 10건 이상에 대해 알림이 정상 전송됨
9. 사용자 피드백 수집 방법이 문서화됨

---

## Tasks / Subtasks

- [ ] Task 1: E2E 테스트 스크립트 (AC: 1, 2, 3)
  - [ ] `tests/e2e_test.py` 작성
  - [ ] 전체 파이프라인 시뮬레이션
  - [ ] 각 단계 검증
  - [ ] 로그 기록

- [ ] Task 2: 헬스체크 API 확장 (AC: 4)
  - [ ] `GET /health` 응답에 메트릭 추가
  - [ ] last_prediction: 마지막 예측 시간
  - [ ] telegram_notifications_sent_24h: 24시간 알림 수
  - [ ] average_prediction_time: 평균 예측 시간

- [ ] Task 3: 모니터링 API (AC: 5)
  - [ ] `backend/api/metrics.py` 작성
  - [ ] `GET /metrics` 엔드포인트
  - [ ] 상세 메트릭 반환

- [ ] Task 4: 메트릭 수집 로직 (AC: 6)
  - [ ] 데이터 수집 성공률 추적
  - [ ] 예측 → 알림 시간 측정
  - [ ] 텔레그램 전송 성공률 추적
  - [ ] Redis에 메트릭 저장

- [ ] Task 5: MVP 검증 (AC: 7, 8)
  - [ ] 테스트 사용자 20명 모집
  - [ ] 실제 중요 뉴스 10건 알림 전송
  - [ ] 사용자 피드백 수집

- [ ] Task 6: 피드백 수집 방법 문서화 (AC: 9)
  - [ ] Google Form 또는 텔레그램 설문
  - [ ] 피드백 항목 정의
  - [ ] README에 문서화

---

## Dev Notes

### E2E Test Scenario

```python
# tests/e2e_test.py

async def test_full_pipeline():
    # 1. 뉴스 크롤링
    news = await crawl_news()
    assert news is not None

    # 2. 주가 수집
    stock_prices = await collect_stock_prices()
    assert len(stock_prices) > 0

    # 3. 뉴스-주가 매칭
    match = await match_news_stock(news)
    assert match is not None

    # 4. 임베딩
    embedding = await embed_news(news)
    assert len(embedding) == 768

    # 5. 예측
    prediction = await predict_news_impact(news)
    assert prediction.impact_score > 0

    # 6. 알림
    sent = await send_notification(prediction)
    assert sent is True
```

### Metrics Response

```json
{
  "crawler_success_rate": 0.96,
  "prediction_avg_time": 4.2,
  "telegram_success_rate": 0.98,
  "total_notifications_sent": 45,
  "active_users": 23,
  "last_24h_notifications": 12
}
```

### Testing

**Test Cases:**
1. E2E 파이프라인 전체 실행
2. 각 단계 검증
3. 메트릭 API 호출
4. 성공률 ≥ 95% 확인

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-31 | 1.0 | Story created from Epic 2 | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used

_To be populated by Dev Agent_

### Debug Log References

_To be populated by Dev Agent_

### Completion Notes List

_To be populated by Dev Agent_

### File List

_To be populated by Dev Agent_

---

## QA Results

_To be populated by QA Agent_
