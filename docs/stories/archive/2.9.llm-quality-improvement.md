# Story 2.9: LLM 예측 품질 개선

**Epic:** 2 - LLM 기반 예측 및 알림 시스템
**Status:** In Progress
**Created:** 2025-11-02
**Type:** Quality Improvement

---

## Story

**As a** 투자자,
**I want** LLM 예측 결과에 대한 명확한 근거와 신뢰할 수 있는 종합 지표를 제공받아,
**so that** 예측을 기반으로 자신감 있게 투자 결정을 내릴 수 있다.

---

## Background

### 기존 구현 (Story 2.2)
- ✅ 기본 LLM 프롬프트 구현 완료
- ✅ 벡터 유사도 검색 (TOP 5 유사 뉴스)
- ✅ GPT-4o 예측 생성 (방향, 신뢰도, 근거)

### 발견된 문제
사용자 피드백 (2025-11-02):
> "신뢰도 점수가 의미가 없어 이걸 보고 내가 투자를 할건데 근거도 모르겠고, 종합 지표도 부족한거 같아. 개발자인 내가 그냥 믿을 수 없어."

**핵심 문제 3가지:**
1. **신뢰도 투명성 부재**: 왜 이 신뢰도 점수인지 설명 없음
2. **예측 근거 불충분**: 과거 패턴만으로는 설득력 부족
3. **종합 지표 부족**: 시장/종목 맥락 정보 누락

**NFR8 미달**: "사용자 만족도 80%" 목표 vs 현재 개발자도 신뢰 불가

---

## Acceptance Criteria

### AC1: 신뢰도 계산 로직 투명화
- [ ] 신뢰도 점수 계산 공식을 명확히 정의
- [ ] 유사 뉴스 개수, 평균 유사도, 과거 패턴 일관성을 반영
- [ ] 신뢰도 구성 요소를 응답에 포함 (예: "유사 뉴스 5건, 평균 유사도 92%, 패턴 일관성 85%")

### AC2: 예측 근거 강화
- [ ] 현재 뉴스 내용뿐 아니라 다음 정보 포함:
  - 종목 특성 (시가총액, 섹터, 최근 실적)
  - 공시 정보 (DART 크롤링 데이터 활용)
  - 현재 주가 위치 (52주 고점/저점 대비)
- [ ] 과거 유사 패턴의 구체적 수치 제공 (평균, 최대, 최소 변동률)

### AC3: 종합 지표 추가
- [ ] 시장 맥락 정보:
  - KOSPI/KOSDAQ 지수 현재 상태
  - 섹터 지수 동향
- [ ] 종목 펀더멘털 정보:
  - 시가총액, PER, PBR (가능한 경우)
- [ ] 시계열 확장:
  - T+1일뿐 아니라 T+2일, T+10일, T+20일 예측 추가

### AC4: 프롬프트 재설계
- [ ] 시스템 역할을 "증권 애널리스트"에서 "종합 투자 어드바이저"로 확장
- [ ] 프롬프트에 명시적으로 "신뢰도 근거 설명" 요구
- [ ] JSON 응답 스키마 확장:
  ```json
  {
    "prediction": "up|down|hold",
    "confidence": 0.85,
    "confidence_breakdown": {
      "similar_news_count": 5,
      "avg_similarity": 0.92,
      "pattern_consistency": 0.85
    },
    "reasoning": "상세 근거 텍스트",
    "similar_patterns": {
      "avg_change": 5.3,
      "max_change": 8.7,
      "min_change": 2.1
    },
    "market_context": {
      "kospi_trend": "up",
      "sector_trend": "neutral"
    },
    "time_series": {
      "t1": 2.5,
      "t2": 3.8,
      "t10": 5.3,
      "t20": 4.2
    }
  }
  ```

### AC5: 품질 검증
- [ ] NFR8 목표 달성: 사용자(개발자) 만족도 확인
- [ ] 10건의 실제 뉴스로 테스트하여 예측 근거의 설득력 평가
- [ ] Telegram/Dashboard UI에 개선된 정보 반영 확인

---

## Tasks / Subtasks

### Priority 1: 즉시 구현 가능 (Low-hanging fruits)

- [ ] **Task 1.1**: 프롬프트 개선 (공시 정보 포함)
  - [ ] `backend/llm/predictor.py` 프롬프트 섹션 수정
  - [ ] DART 크롤링 데이터를 프롬프트에 추가
  - [ ] 종목 특성 정보 추가 (DB에서 stock 정보 조회)

- [ ] **Task 1.2**: 신뢰도 계산 로직 투명화
  - [ ] 유사 뉴스 개수, 평균 유사도 계산
  - [ ] 과거 패턴 일관성 점수 추가 (변동률 표준편차 기반)
  - [ ] JSON 응답에 `confidence_breakdown` 필드 추가

- [ ] **Task 1.3**: 예측 근거 구체화
  - [ ] 유사 뉴스 패턴 통계 계산 (평균/최대/최소)
  - [ ] JSON 응답에 `similar_patterns` 필드 추가

### Priority 2: 데이터 보강 (Medium-term)

- [ ] **Task 2.1**: 시장 지수 수집
  - [ ] KOSPI/KOSDAQ 일봉 데이터 수집 스크립트
  - [ ] `market_indices` 테이블 생성
  - [ ] 1분마다 현재 지수 수집 (장중)

- [ ] **Task 2.2**: 섹터 지수 수집
  - [ ] 업종별 지수 데이터 수집
  - [ ] `sector_indices` 테이블 생성
  - [ ] 종목-섹터 매핑 정보 추가

- [ ] **Task 2.3**: 종목 펀더멘털 정보
  - [ ] 시가총액, PER, PBR 데이터 수집
  - [ ] `stocks` 테이블에 컬럼 추가
  - [ ] 주간 업데이트 스케줄러

- [ ] **Task 2.4**: 시계열 확장
  - [ ] 뉴스-주가 매칭 로직 수정 (T+2, T+10, T+20일 추가)
  - [ ] `news_stock_match` 테이블 컬럼 추가
  - [ ] LLM 프롬프트에 확장된 시계열 포함

### Priority 3: 고급 기능 (Advanced)

- [ ] **Task 3.1**: Multi-model 앙상블
  - [ ] GPT-4o + Claude 3.5 Sonnet 병렬 호출
  - [ ] 예측 결과 앙상블 로직
  - [ ] 비용 vs 품질 트레이드오프 평가

- [ ] **Task 3.2**: 피드백 루프
  - [ ] 예측 vs 실제 결과 비교 로직
  - [ ] 예측 정확도 추적 테이블
  - [ ] 프롬프트 자동 조정 메커니즘

- [ ] **Task 3.3**: 자동 프롬프트 최적화
  - [ ] A/B 테스트 프레임워크
  - [ ] 프롬프트 변형 성능 비교

---

## Implementation Plan

### Phase 1 (Immediate - 1-2일)
**목표**: 즉시 체감 가능한 품질 개선
- Task 1.1: 프롬프트 개선 (공시 정보)
- Task 1.2: 신뢰도 투명화
- Task 1.3: 예측 근거 구체화
- **Outcome**: 사용자가 예측을 신뢰할 수 있는 수준 달성

### Phase 2 (Data Enhancement - 3-5일)
**목표**: 맥락 정보 보강
- Task 2.1: 시장 지수 수집
- Task 2.2: 섹터 지수 수집
- Task 2.3: 종목 펀더멘털
- Task 2.4: 시계열 확장
- **Outcome**: 종합적 투자 판단 지원

### Phase 3 (Advanced - Optional)
**목표**: 장기적 품질 향상
- Task 3.1: Multi-model 앙상블
- Task 3.2: 피드백 루프
- Task 3.3: 프롬프트 최적화
- **Outcome**: 지속적 개선 시스템

---

## Technical Notes

### 현재 `predictor.py` 구조
```python
# backend/llm/predictor.py
def predict_stock_movement(news: NewsArticle, similar_news: List[NewsArticle], current_price: float) -> PredictionResult:
    prompt = build_prompt(news, similar_news, current_price)
    response = openai_client.chat.completions.create(
        model="gpt-4o",
        messages=[{"role": "system", "content": SYSTEM_ROLE}, {"role": "user", "content": prompt}],
        temperature=0.3,
        response_format={"type": "json_object"}
    )
    return parse_response(response)
```

### 개선 방향
1. **입력 데이터 확장**: `build_prompt()` 함수에 추가 정보 포함
2. **응답 스키마 확장**: `PredictionResult` Pydantic 모델 업데이트
3. **신뢰도 로직**: `parse_response()` 후 추가 계산

---

## Success Metrics

### 정량적 지표
- [ ] 신뢰도 구성 요소 3가지 이상 제공
- [ ] 유사 패턴 통계 (평균/최대/최소) 제공
- [ ] 시계열 예측 4개 시점 이상 (T+1, T+2, T+10, T+20)
- [ ] 시장/섹터 맥락 정보 포함

### 정성적 지표
- [ ] NFR8 달성: 사용자(개발자) 만족도 "신뢰 가능" 수준
- [ ] 예측 근거가 투자 결정에 충분한 정보 제공
- [ ] Telegram 알림 메시지가 actionable insights 포함

---

## Dependencies

### 기존 시스템
- ✅ Story 2.1: 벡터 유사도 검색 (사용)
- ✅ Story 2.2: 기본 LLM 프롬프트 (개선)
- ⚠️ Story 1.4: 뉴스 크롤러 (DART 데이터 사용)
- ⚠️ Story 1.5: 주가 수집 (시계열 확장 필요)

### 새로운 데이터 소스
- KOSPI/KOSDAQ 지수 (새 수집 필요)
- 섹터 지수 (새 수집 필요)
- 종목 펀더멘털 (새 수집 필요)

---

## Risks & Mitigations

### Risk 1: API 비용 증가
- **Risk**: 프롬프트 확장으로 토큰 사용량 증가
- **Impact**: Medium
- **Mitigation**:
  - 캐싱 강화 (Redis TTL 연장)
  - 프롬프트 압축 기법 적용
  - 비용 모니터링 대시보드

### Risk 2: 응답 시간 증가
- **Risk**: 추가 데이터 조회로 예측 시간 증가
- **Impact**: Medium
- **Mitigation**:
  - 데이터 사전 로드 (메모리 캐시)
  - 비동기 병렬 조회
  - NFR1 목표 (5분 이내) 유지

### Risk 3: 데이터 부족
- **Risk**: 시장 지수, 펀더멘털 데이터 수집 실패
- **Impact**: Low
- **Mitigation**:
  - Phase 1 (즉시 구현)은 데이터 의존성 없음
  - Phase 2는 단계적 추가 (optional)

---

## Testing Plan

### Unit Tests
- [ ] `build_prompt()` - 확장된 입력 검증
- [ ] `calculate_confidence_breakdown()` - 신뢰도 계산 로직
- [ ] `parse_response()` - 확장된 JSON 스키마 파싱

### Integration Tests
- [ ] End-to-end: 뉴스 입력 → 개선된 예측 출력
- [ ] Telegram 메시지 포맷 검증
- [ ] Dashboard API 응답 검증

### User Acceptance Test
- [ ] 개발자(사용자)가 10건의 실제 뉴스 예측 검토
- [ ] "투자 결정에 도움이 되는가?" 평가
- [ ] NFR8 목표 달성 확인

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-02 | 1.0 | Story created from Correct Course Task | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used

_To be populated by Dev Agent_

### Debug Log References

_To be populated by Dev Agent_

### Completion Notes List

_To be populated by Dev Agent_

### File List

_To be populated by Dev Agent_

---

## QA Results

_To be populated by QA Agent_
