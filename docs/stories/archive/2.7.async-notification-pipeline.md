# Story 2.7: async-notification-pipeline

**Epic:** 2 - LLM 기반 예측 및 알림 시스템
**Status:** Completed

---

## Story

**As a** 시스템,
**I want** 새 뉴스 감지 시 예측 분석부터 텔레그램 전송까지 비동기로 처리하여,
**so that** 5분 이내 알림을 보낼 수 있다.

---

## Acceptance Criteria

1. 뉴스 감지 트리거가 10분마다 실행되며 새 뉴스를 확인한다.
2. 새 뉴스 발견 시 Celery 태스크를 큐에 추가한다.
3. Celery 워커가 순차 실행한다:
   - 벡터 유사도 검색
   - LLM 예측 분석
   - 시간대 판별
   - 메시지 생성
   - 영향도 필터링
   - 텔레그램 전송
4. 전체 파이프라인이 평균 3분 이내 완료된다.
5. 각 단계의 실행 시간을 로그로 기록한다.
6. 에러 발생 시 Celery 재시도 정책이 작동한다 (최대 3회).
7. 로컬 테스트: 새 뉴스 삽입 → 5분 이내 텔레그램 알림 수신

---

## Tasks / Subtasks

- [ ] Task 1: Celery 설정 (AC: 2)
  - [ ] `backend/celery_app.py` 생성
  - [ ] Celery 앱 초기화
  - [ ] Redis broker 설정

- [ ] Task 2: 뉴스 감지 태스크 (AC: 1)
  - [ ] `backend/scheduler/news_detector.py` 작성
  - [ ] 10분마다 새 뉴스 확인
  - [ ] APScheduler 통합

- [ ] Task 3: 예측 파이프라인 Celery 태스크 (AC: 3)
  - [ ] `backend/tasks/prediction_pipeline.py` 작성
  - [ ] @celery_app.task 데코레이터
  - [ ] 6단계 순차 실행

- [ ] Task 4: 각 단계 구현 (AC: 3)
  - [ ] 1. similarity_search()
  - [ ] 2. predict_news_impact()
  - [ ] 3. classify_market_time()
  - [ ] 4. build_telegram_message()
  - [ ] 5. should_send_notification()
  - [ ] 6. send_telegram_notification()

- [ ] Task 5: 실행 시간 로깅 (AC: 5)
  - [ ] 각 단계 시작/종료 시간 기록
  - [ ] 총 실행 시간 계산

- [ ] Task 6: 에러 처리 및 재시도 (AC: 6)
  - [ ] Celery retry 설정 (max_retries=3)
  - [ ] exponential backoff

- [ ] Task 7: 텔레그램 전송 함수 (AC: 3, 7)
  - [ ] send_telegram_notification() 함수
  - [ ] 모든 active 사용자에게 전송

- [ ] Task 8: 통합 테스트 (AC: 7)
  - [ ] 새 뉴스 삽입
  - [ ] 5분 이내 알림 수신 확인
  - [ ] 파이프라인 각 단계 로그 확인

---

## Dev Notes

### Celery Task

```python
from celery import Task
from backend.celery_app import celery_app

@celery_app.task(bind=True, max_retries=3)
def process_news_prediction(self, news_id: int):
    try:
        # 1. 유사도 검색
        similar_news = await search_similar_news(news_text)

        # 2. LLM 예측
        prediction = await predict_news_impact(news, similar_news)

        # 3. 시간대 판별
        market_time = classify_market_time(news.published_at)

        # 4. 메시지 생성
        message = build_telegram_message(prediction, market_time, news)

        # 5. 필터링
        if should_send_notification(prediction, news.stock_code):
            # 6. 텔레그램 전송
            await send_telegram_notification(message)

    except Exception as exc:
        raise self.retry(exc=exc, countdown=60 * (2 ** self.request.retries))
```

### Performance Target

- 유사도 검색: <100ms
- LLM 예측: 2-5초
- 메시지 생성: <100ms
- 텔레그램 전송: <1초
- **총 파이프라인: <3분** (평균)

### Testing

**Test Cases:**
1. 새 뉴스 삽입
2. Celery 태스크 큐 추가
3. 파이프라인 실행
4. 텔레그램 메시지 수신 (5분 이내)
5. 각 단계 로그 확인

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-31 | 1.0 | Story created from Epic 2 | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used

_To be populated by Dev Agent_

### Debug Log References

_To be populated by Dev Agent_

### Completion Notes List

_To be populated by Dev Agent_

### File List

_To be populated by Dev Agent_

---

## QA Results

_To be populated by QA Agent_
