# Story 1.5: stock-price-collector

**Epic:** 1 - 데이터 수집 및 저장 인프라
**Status:** Draft

---

## Story

**As a** 시스템,
**I want** 1분마다 코스피/코스닥 주가 데이터를 수집하여 PostgreSQL에 저장하고,
**so that** 실시간에 가까운 주가 정보를 확보한다.

---

## Acceptance Criteria

1. 주가 수집기(`backend/crawlers/stock_crawler.py`)가 FinanceDataReader를 사용하여 주가 데이터를 수집한다.
2. APScheduler로 1분마다 수집기가 자동 실행된다 (장중 9:00~15:30).
3. 대형주(시가총액 상위 50개)를 우선 수집하며, 종목 리스트는 설정 파일로 관리된다.
4. 시가/고가/저가/종가/거래량 데이터를 `stock_prices` 테이블에 저장한다.
5. 장 시작 전(9:00 이전)과 장 마감 후(15:30 이후)는 수집을 중단한다.
6. 수집 실패 시 에러 로그를 기록하고, 다음 주기에 재시도한다.
7. 로컬 테스트: 특정 종목의 1분봉 데이터가 정상 저장된다.

---

## Tasks / Subtasks

- [ ] Task 1: 종목 리스트 설정 (AC: 3)
  - [ ] `data/target_stocks.json` 생성
  - [ ] 대형주 50개 종목코드 리스트
  - [ ] JSON 로드 함수

- [ ] Task 2: 주가 수집기 작성 (AC: 1, 4)
  - [ ] `backend/crawlers/stock_crawler.py` 생성
  - [ ] FinanceDataReader.DataReader() 사용
  - [ ] 1분봉 데이터 수집
  - [ ] StockPrice 모델에 저장

- [ ] Task 3: 장 시간 판별 로직 (AC: 5)
  - [ ] `backend/utils/market_time.py` 작성
  - [ ] is_market_open() 함수
  - [ ] 평일 9:00-15:30 판별
  - [ ] 공휴일 체크 (추후 확장)

- [ ] Task 4: APScheduler 스케줄러 설정 (AC: 2)
  - [ ] 1분 주기 IntervalTrigger
  - [ ] 장 시간에만 실행되도록 조건 추가
  - [ ] `backend/scheduler/crawler_scheduler.py`에 통합

- [ ] Task 5: 에러 처리 및 로깅 (AC: 6)
  - [ ] FinanceDataReader 에러 처리
  - [ ] 종목별 수집 실패 로그
  - [ ] 재시도 로직

- [ ] Task 6: 테스트 (AC: 7)
  - [ ] 특정 종목(005930) 1분봉 수집
  - [ ] DB 저장 확인
  - [ ] 장외 시간 수집 중단 확인

---

## Dev Notes

### FinanceDataReader Usage

```python
import FinanceDataReader as fdr

# 1분봉 데이터 (최근)
df = fdr.DataReader('005930', start='2025-10-31')
# Columns: Date, Open, High, Low, Close, Volume
```

### Market Hours

- **장 시작**: 09:00 KST
- **장 마감**: 15:30 KST
- **평일만**: 월~금
- **공휴일**: 추후 확장 (holidays 라이브러리)

### Data Storage

- 1분봉 데이터를 `stock_prices` 테이블에 저장
- `date` 필드: 분 단위 타임스탬프
- 중복 방지: (stock_code, date) UNIQUE 제약 조건

### Testing

**Test Location**: `tests/integration/test_stock_crawler.py`

**Test Cases:**
1. FinanceDataReader 데이터 수집
2. StockPrice 모델 저장
3. 장 시간 판별 로직
4. 1분 주기 스케줄러 동작

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-31 | 1.0 | Story created from Epic 1 | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used

_To be populated by Dev Agent_

### Debug Log References

_To be populated by Dev Agent_

### Completion Notes List

_To be populated by Dev Agent_

### File List

_To be populated by Dev Agent_

---

## QA Results

_To be populated by QA Agent_
