# Story 2.5: notification-filter

**Epic:** 2 - LLM 기반 예측 및 알림 시스템
**Status:** Draft

---

## Story

**As a** 시스템,
**I want** LLM 예측 결과 중 영향도 8.0 이상인 뉴스만 알림 대상으로 선정하여,
**so that** 중요한 뉴스만 사용자에게 전달하고 알림 피로도를 방지할 수 있다.

---

## Acceptance Criteria

1. 알림 트리거 함수(`backend/telegram/notification_filter.py`)가 구현된다.
2. 입력: LLM 예측 결과, 출력: True(알림 전송) | False(전송 안 함)
3. 필터링 기준:
   - 영향도 점수 ≥ 8.0
   - 상승 또는 하락 확률 ≥ 70%
4. 동일 종목에 대해 1시간 내 중복 알림을 방지한다 (Redis 캐시).
5. 필터링 로그를 기록한다.
6. 로컬 테스트: 영향도 7.5는 필터링, 8.5는 통과한다.

---

## Tasks / Subtasks

- [ ] Task 1: 필터링 함수 (AC: 1, 2, 3)
  - [ ] `backend/telegram/notification_filter.py` 생성
  - [ ] should_send_notification() 함수
  - [ ] 영향도 점수 ≥ 8.0 체크
  - [ ] confidence_score ≥ 0.7 체크

- [ ] Task 2: Redis 중복 방지 (AC: 4)
  - [ ] Redis 키: `notification:{stock_code}`
  - [ ] TTL: 3600초 (1시간)
  - [ ] 중복 체크 로직

- [ ] Task 3: 로깅 (AC: 5)
  - [ ] 필터링 이유 로그
  - [ ] 통과/거부 카운트

- [ ] Task 4: 테스트 (AC: 6)
  - [ ] 영향도 7.5 → False
  - [ ] 영향도 8.5 → True
  - [ ] 1시간 내 중복 → False

---

## Dev Notes

### Filtering Logic

```python
def should_send_notification(prediction: PredictionResult, stock_code: str) -> bool:
    # 1. 영향도 체크
    if prediction.impact_score < 8.0:
        return False

    # 2. 신뢰도 체크
    if prediction.confidence_score < 0.7:
        return False

    # 3. Redis 중복 체크
    key = f"notification:{stock_code}"
    if redis_client.exists(key):
        return False

    # 4. Redis 키 설정 (1시간 TTL)
    redis_client.setex(key, 3600, "1")

    return True
```

### Testing

**Test Cases:**
1. impact_score=7.5 → False
2. impact_score=8.5, confidence=0.8 → True
3. 중복 알림 (1시간 내) → False

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-31 | 1.0 | Story created from Epic 2 | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used

_To be populated by Dev Agent_

### Debug Log References

_To be populated by Dev Agent_

### Completion Notes List

_To be populated by Dev Agent_

### File List

_To be populated by Dev Agent_

---

## QA Results

_To be populated by QA Agent_
