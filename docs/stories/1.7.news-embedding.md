# Story 1.7: news-embedding

**Epic:** 1 - 데이터 수집 및 저장 인프라
**Status:** Draft

---

## Story

**As a** 시스템,
**I want** 수집된 뉴스를 OpenAI Embedding API로 임베딩하여 Milvus에 저장하고,
**so that** 유사 뉴스 검색이 가능하다.

---

## Acceptance Criteria

1. 임베딩 스크립트(`backend/llm/embedder.py`)가 매일 장 마감 후(16:00) 실행된다.
2. 아직 임베딩되지 않은 뉴스를 `news` 테이블에서 조회한다.
3. OpenAI text-embedding-3-small API로 뉴스를 768차원 벡터로 변환한다.
4. 벡터와 메타데이터를 Milvus `news_embeddings` 컬렉션에 저장한다.
5. 임베딩 비용이 1건당 $0.0001 이하로 유지된다.
6. 임베딩 실패 시 에러 로그를 기록하고, 다음 실행 시 재시도한다.
7. 로컬 테스트: 100건 뉴스 임베딩 및 Milvus 저장이 성공한다.

---

## Tasks / Subtasks

- [ ] Task 1: OpenAI Embedding 클라이언트 (AC: 3)
  - [ ] `backend/llm/embedder.py` 작성
  - [ ] OpenAI API 클라이언트 초기화
  - [ ] embed_text() 함수 (text-embedding-3-small)

- [ ] Task 2: 미임베딩 뉴스 조회 (AC: 2)
  - [ ] PostgreSQL 쿼리
  - [ ] Milvus에 존재하지 않는 news_id 필터링

- [ ] Task 3: 배치 임베딩 처리 (AC: 3, 5)
  - [ ] 100건씩 배치 처리
  - [ ] API 비용 모니터링

- [ ] Task 4: Milvus 저장 (AC: 4)
  - [ ] collection.insert() 호출
  - [ ] 메타데이터 (stock_code, published_timestamp) 포함

- [ ] Task 5: APScheduler 통합 (AC: 1)
  - [ ] CronTrigger (매일 16:00)

- [ ] Task 6: 에러 처리 및 재시도 (AC: 6)
  - [ ] OpenAI API 에러 처리
  - [ ] 실패 뉴스 로그 기록

- [ ] Task 7: 테스트 (AC: 7)
  - [ ] 100건 뉴스 임베딩
  - [ ] Milvus 저장 확인

---

## Dev Notes

### OpenAI Embedding API

```python
from openai import OpenAI

client = OpenAI(api_key=settings.OPENAI_API_KEY)

response = client.embeddings.create(
    model="text-embedding-3-small",
    input="뉴스 텍스트",
)

embedding = response.data[0].embedding  # 768-dim vector
```

### Cost Management

- text-embedding-3-small: $0.00002 per 1K tokens
- 한국어 뉴스 평균 200 tokens
- 1건당 약 $0.000004 ($0.0001 이하 달성)

### Testing

**Test Cases:**
1. OpenAI API 호출 성공
2. 768차원 벡터 생성
3. Milvus 삽입 성공
4. 배치 처리 (100건)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-31 | 1.0 | Story created from Epic 1 | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used

_To be populated by Dev Agent_

### Debug Log References

_To be populated by Dev Agent_

### Completion Notes List

_To be populated by Dev Agent_

### File List

_To be populated by Dev Agent_

---

## QA Results

_To be populated by QA Agent_
