# Story 2.1: vector-similarity-search

**Epic:** 2 - LLM 기반 예측 및 알림 시스템
**Status:** Completed

---

## Story

**As a** 시스템,
**I want** 새로운 뉴스의 임베딩을 생성하고 Milvus에서 유사한 과거 뉴스 TOP 5를 검색하여,
**so that** LLM이 과거 패턴을 참조할 수 있다.

---

## Acceptance Criteria

1. 유사도 검색 함수(`backend/llm/similarity_search.py`)가 구현된다.
2. 입력: 뉴스 텍스트, 출력: 유사 뉴스 TOP 5 (news_id, 유사도, 제목, 종목코드, 변동률)
3. OpenAI text-embedding-3-small로 입력 뉴스를 임베딩한다.
4. Milvus에서 L2 거리 기반 유사도 검색을 수행한다.
5. 검색 결과에서 PostgreSQL과 조인하여 상세 정보를 가져온다.
6. 검색 시간이 100ms 이내로 완료된다.
7. 로컬 테스트: 유사한 뉴스들이 정확히 반환된다.

---

## Tasks / Subtasks

- [ ] Task 1: 유사도 검색 함수 작성 (AC: 1, 2)
  - [ ] `backend/llm/similarity_search.py` 생성
  - [ ] search_similar_news() 함수
  - [ ] 입력: 뉴스 텍스트
  - [ ] 출력: List[SimilarNews] Pydantic 모델

- [ ] Task 2: 뉴스 임베딩 생성 (AC: 3)
  - [ ] embedder.embed_text() 재사용
  - [ ] 768차원 벡터 반환

- [ ] Task 3: Milvus 검색 (AC: 4, 6)
  - [ ] collection.search() 호출
  - [ ] search_params: {"metric_type": "L2", "params": {"nprobe": 10}}
  - [ ] TOP 5 결과 반환
  - [ ] 성능 목표: <100ms

- [ ] Task 4: PostgreSQL 조인 (AC: 5)
  - [ ] news_id로 news 테이블 조회
  - [ ] news_stock_match 테이블 조인
  - [ ] 제목, 종목코드, 변동률 가져오기

- [ ] Task 5: 결과 Pydantic 모델 (AC: 2)
  - [ ] SimilarNews 모델 정의
    - news_id: int
    - distance: float
    - title: str
    - stock_code: str
    - price_change_1d/3d/5d: float

- [ ] Task 6: 테스트 (AC: 7)
  - [ ] 샘플 뉴스로 검색
  - [ ] TOP 5 결과 검증
  - [ ] 검색 시간 측정

---

## Dev Notes

### Search Implementation

```python
from pymilvus import Collection
from backend.llm.embedder import embed_text

async def search_similar_news(news_text: str, top_k: int = 5) -> List[SimilarNews]:
    # 1. Embed input
    embedding = await embed_text(news_text)

    # 2. Milvus search
    collection = Collection("news_embeddings")
    results = collection.search(
        data=[embedding],
        anns_field="embedding",
        param={"metric_type": "L2", "params": {"nprobe": 10}},
        limit=top_k,
        output_fields=["news_article_id", "stock_code"]
    )

    # 3. PostgreSQL join
    news_ids = [hit.entity.get("news_article_id") for hit in results[0]]
    news_data = await fetch_news_by_ids(news_ids)

    # 4. Combine results
    similar_news = []
    for hit, news in zip(results[0], news_data):
        similar_news.append(SimilarNews(
            news_id=news.id,
            distance=hit.distance,
            title=news.title,
            stock_code=news.stock_code,
            price_change_1d=news.match.price_change_1d,
            ...
        ))

    return similar_news
```

### Performance Optimization

- nprobe=10: 검색 정확도와 속도 균형
- connection pooling: PostgreSQL 연결 재사용
- async/await: 비동기 처리

### Testing

**Test Location**: `tests/integration/test_similarity_search.py`

**Test Cases:**
1. 샘플 뉴스 검색
2. TOP 5 결과 반환
3. 거리 오름차순 정렬
4. 검색 시간 <100ms

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-31 | 1.0 | Story created from Epic 2 | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used

_To be populated by Dev Agent_

### Debug Log References

_To be populated by Dev Agent_

### Completion Notes List

_To be populated by Dev Agent_

### File List

_To be populated by Dev Agent_

---

## QA Results

_To be populated by QA Agent_
