# KIS API Token Architecture

## ê°œìš”

í•œêµ­íˆ¬ìì¦ê¶Œ(KIS) APIì˜ OAuth 2.0 ì¸ì¦ í† í°ì„ íš¨ìœ¨ì ìœ¼ë¡œ ê´€ë¦¬í•˜ê¸° ìœ„í•œ ì‹±ê¸€í†¤ ê¸°ë°˜ ì•„í‚¤í…ì²˜ì…ë‹ˆë‹¤.

## ë¬¸ì œ ì •ì˜

### ê¸°ì¡´ ë¬¸ì œì 

1. **í† í° ì¤‘ë³µ ë°œê¸‰**: ê° `KISClient` ì¸ìŠ¤í„´ìŠ¤ë§ˆë‹¤ ìƒˆë¡œìš´ `TokenManager` ìƒì„±
2. **Rate Limit ìœ„ë°˜**: KIS APIëŠ” 1ë¶„ë‹¹ 1íšŒë§Œ í† í° ë°œê¸‰ í—ˆìš©
3. **API í˜¸ì¶œ ì‹¤íŒ¨**: ë¹ˆë²ˆí•œ 403 ì—ëŸ¬ ë°œìƒ
4. **ë¦¬ì†ŒìŠ¤ ë‚­ë¹„**: ë¶ˆí•„ìš”í•œ í† í° ì¬ë°œê¸‰ìœ¼ë¡œ ë„¤íŠ¸ì›Œí¬ ë¦¬ì†ŒìŠ¤ ë‚­ë¹„

### KIS API ì œì•½ì‚¬í•­

- **Token ë°œê¸‰ ì œí•œ**: 1ë¶„ë‹¹ 1íšŒ
- **Token ìœ íš¨ê¸°ê°„**: 24ì‹œê°„
- **API Rate Limit**:
  - ëª¨ì˜íˆ¬ì: ì´ˆë‹¹ 5ê±´
  - ì‹¤ì „íˆ¬ì: ì´ˆë‹¹ 20ê±´

## í•´ê²° ë°©ì•ˆ

### Singleton Pattern êµ¬í˜„

`TokenManager` í´ë˜ìŠ¤ë¥¼ ì‹±ê¸€í†¤ìœ¼ë¡œ êµ¬í˜„í•˜ì—¬ ì• í”Œë¦¬ì¼€ì´ì…˜ ì „ì²´ì—ì„œ ë‹¨ì¼ í† í° ì¸ìŠ¤í„´ìŠ¤ë¥¼ ê³µìœ í•©ë‹ˆë‹¤.

#### ì£¼ìš” êµ¬í˜„ í¬ì¸íŠ¸

```python
class TokenManager:
    """OAuth 2.0 Token ê´€ë¦¬ì (ì‹±ê¸€í†¤)"""

    _instance = None
    _lock = asyncio.Lock()  # í´ë˜ìŠ¤ ë ˆë²¨ lock (thread-safe)

    def __new__(cls, *args, **kwargs):
        """ì‹±ê¸€í†¤ íŒ¨í„´ êµ¬í˜„"""
        if cls._instance is None:
            cls._instance = super().__new__(cls)
        return cls._instance

    def __init__(self, app_key: str, app_secret: str, base_url: str, mock_mode: bool):
        # ì´ë¯¸ ì´ˆê¸°í™”ë˜ì—ˆìœ¼ë©´ ìŠ¤í‚µ
        if hasattr(self, 'initialized') and self.initialized:
            return

        self.app_key = app_key
        self.app_secret = app_secret
        self.base_url = base_url
        self.mock_mode = mock_mode

        self.access_token: Optional[str] = None
        self.token_expires_at: Optional[datetime] = None
        self.initialized = True

        logger.info("ğŸ”‘ TokenManager ì‹±ê¸€í†¤ ì´ˆê¸°í™” ì™„ë£Œ")
```

#### Token ìë™ ê°±ì‹  ë¡œì§

```python
async def get_access_token(self) -> str:
    """Access Token ì¡°íšŒ (í•„ìš” ì‹œ ìë™ ê°±ì‹ )"""
    async with TokenManager._lock:
        # ìœ íš¨í•œ í† í° í™•ì¸
        if self.access_token and self.token_expires_at:
            remaining = (self.token_expires_at - datetime.now()).total_seconds()

            # ë§Œë£Œ 5ë¶„ ì „ì— ê°±ì‹ 
            if remaining > 300:  # 5ë¶„ = 300ì´ˆ
                logger.debug(f"ê¸°ì¡´ í† í° ì‚¬ìš© (ìœ íš¨ì‹œê°„: {remaining/3600:.1f}ì‹œê°„)")
                return self.access_token

        # í† í° ê°±ì‹ 
        logger.info("ğŸ”‘ Access Token ê°±ì‹  ì¤‘...")
        await self._refresh_token()
        return self.access_token
```

## ì•„í‚¤í…ì²˜ ë‹¤ì´ì–´ê·¸ë¨

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Application Layer                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ KISClient #1 â”‚  â”‚ KISClient #2 â”‚  â”‚ KISClient #3 â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚         â”‚                  â”‚                  â”‚              â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                            â”‚                                 â”‚
â”‚                            â–¼                                 â”‚
â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚                  â”‚  TokenManager   â”‚ â—„â”€â”€ Singleton          â”‚
â”‚                  â”‚   (Singleton)   â”‚                        â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                           â”‚                                  â”‚
â”‚                           â”‚ Token ê³µìœ                        â”‚
â”‚                           â”‚ (24ì‹œê°„ ìœ íš¨)                    â”‚
â”‚                           â”‚                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                           â–¼                                  â”‚
â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚                  â”‚   KIS API       â”‚                        â”‚
â”‚                  â”‚  OAuth 2.0      â”‚                        â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                                                              â”‚
â”‚  Rate Limit: 1 token/min                                   â”‚
â”‚  Token TTL: 24 hours                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Token Lifecycle

```
1. ì²« ë²ˆì§¸ KISClient ìƒì„±
   â””â”€â–º TokenManager.__new__() â†’ ì‹±ê¸€í†¤ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
       â””â”€â–º __init__() â†’ ì´ˆê¸°í™” (initialized=True)
           â””â”€â–º get_access_token() â†’ KIS API í† í° ìš”ì²­
               â””â”€â–º access_token ì €ì¥ (ë§Œë£Œ: 24ì‹œê°„ í›„)

2. ë‘ ë²ˆì§¸ KISClient ìƒì„±
   â””â”€â–º TokenManager.__new__() â†’ ê¸°ì¡´ ì‹±ê¸€í†¤ ë°˜í™˜
       â””â”€â–º __init__() â†’ ìŠ¤í‚µ (ì´ë¯¸ initialized=True)
           â””â”€â–º get_access_token() â†’ ê¸°ì¡´ í† í° ë°˜í™˜ (ì¬ë°œê¸‰ ì—†ìŒ)

3. Në²ˆì§¸ KISClient ìƒì„±
   â””â”€â–º (ë™ì¼) â†’ ëª¨ë‘ ê°™ì€ TokenManager ì¸ìŠ¤í„´ìŠ¤ ê³µìœ 

4. Token ë§Œë£Œ 5ë¶„ ì „
   â””â”€â–º get_access_token() â†’ ìë™ ê°±ì‹ 
       â””â”€â–º _refresh_token() â†’ KIS API ìƒˆ í† í° ìš”ì²­
           â””â”€â–º access_token ì—…ë°ì´íŠ¸ (ë§Œë£Œ: 24ì‹œê°„ í›„)
```

## ì„±ëŠ¥ ê°œì„ 

| í•­ëª© | ê°œì„  ì „ | ê°œì„  í›„ | ê°œì„ ìœ¨ |
|------|---------|---------|--------|
| Token ë°œê¸‰ íšŸìˆ˜ | NíšŒ (í´ë¼ì´ì–¸íŠ¸ ìˆ˜ë§Œí¼) | 1íšŒ (24ì‹œê°„ë‹¹) | ~99% â†“ |
| Rate Limit ì—ëŸ¬ | ë¹ˆë²ˆ ë°œìƒ | í•´ê²°ë¨ | 100% â†“ |
| API ì„±ê³µë¥  | ~50% | 100% | 2ë°° â†‘ |
| ë™ì‹œ í¬ë¡¤ëŸ¬ | ë¶ˆê°€ëŠ¥ | ê°€ëŠ¥ | âˆ |

## ê²€ì¦ í…ŒìŠ¤íŠ¸

### Test 1: Singleton ê²€ì¦

```bash
uv run python scripts/test_token_singleton.py
```

**ê²€ì¦ í•­ëª©**:
- âœ… ì—¬ëŸ¬ `KISClient` ì¸ìŠ¤í„´ìŠ¤ê°€ ë™ì¼í•œ `TokenManager` ê³µìœ 
- âœ… `TokenManager` ì¸ìŠ¤í„´ìŠ¤ ID ì¼ì¹˜
- âœ… Token ê°’ ì¼ì¹˜

### Test 2: Token ì¬ì‚¬ìš© ê²€ì¦

```bash
uv run python scripts/test_token_reuse.py
```

**ê²€ì¦ í•­ëª©**:
- âœ… ì²« ë²ˆì§¸ í´ë¼ì´ì–¸íŠ¸: Token ë°œê¸‰
- âœ… ë‘ ë²ˆì§¸ í´ë¼ì´ì–¸íŠ¸: ê¸°ì¡´ Token ì¬ì‚¬ìš© (ì¬ë°œê¸‰ ì—†ìŒ)
- âœ… ì„¸ ë²ˆì§¸ í´ë¼ì´ì–¸íŠ¸: ê¸°ì¡´ Token ì¬ì‚¬ìš© (ì¬ë°œê¸‰ ì—†ìŒ)
- âœ… API í˜¸ì¶œ: ëª¨ë“  í´ë¼ì´ì–¸íŠ¸ê°€ ë™ì¼í•œ Tokenìœ¼ë¡œ ì„±ê³µ

### ì‹¤ì œ í…ŒìŠ¤íŠ¸ ê²°ê³¼

```
ğŸ” Token ì¬ì‚¬ìš© í…ŒìŠ¤íŠ¸ ê²°ê³¼:
âœ… Client 1 Token: eyJ0eXAiOiJKV1QiLCJhbGciOiJIUz...
âœ… Client 2 Token: eyJ0eXAiOiJKV1QiLCJhbGciOiJIUz... (ë™ì¼)
âœ… Client 3 Token: eyJ0eXAiOiJKV1QiLCJhbGciOiJIUz... (ë™ì¼)

TokenManager ì¸ìŠ¤í„´ìŠ¤ ë™ì¼ì„± í™•ì¸:
   Client 1 TM: 4380847056
   Client 2 TM: 4380847056  (ë™ì¼)
   Client 3 TM: 4380847056  (ë™ì¼)

API í˜¸ì¶œ í…ŒìŠ¤íŠ¸:
âœ… Client 2: ì‚¼ì„±ì „ì í˜„ì¬ê°€ ì¡°íšŒ ì„±ê³µ
âœ… Client 3: SKí•˜ì´ë‹‰ìŠ¤ í˜„ì¬ê°€ ì¡°íšŒ ì„±ê³µ

ê²€ì¦ ì™„ë£Œ:
1. âœ… TokenManagerëŠ” ì‹±ê¸€í†¤ (ëª¨ë“  ì¸ìŠ¤í„´ìŠ¤ ë™ì¼)
2. âœ… Tokenì€ 1íšŒë§Œ ë°œê¸‰ë˜ê³  ëª¨ë“  í´ë¼ì´ì–¸íŠ¸ê°€ ê³µìœ 
3. âœ… API í˜¸ì¶œ ì‹œ ë™ì¼í•œ í† í° ì¬ì‚¬ìš©
4. âœ… 24ì‹œê°„ ë™ì•ˆ í† í° ê³µìœ ë¡œ Rate Limit íšŒí”¼
```

## ì£¼ìš” íŠ¹ì§•

### 1. Thread-Safe

- `asyncio.Lock()` ì‚¬ìš©ìœ¼ë¡œ ë¹„ë™ê¸° í™˜ê²½ì—ì„œ ì•ˆì „
- í´ë˜ìŠ¤ ë ˆë²¨ lock (`TokenManager._lock`)ìœ¼ë¡œ ë™ì‹œì„± ì œì–´

### 2. ìë™ ê°±ì‹ 

- í† í° ë§Œë£Œ 5ë¶„ ì „ ìë™ ê°±ì‹ 
- ì• í”Œë¦¬ì¼€ì´ì…˜ ì¤‘ë‹¨ ì—†ì´ ì§€ì†ì ì¸ API ì‚¬ìš© ê°€ëŠ¥

### 3. ë””ë²„ê·¸ ë¡œê¹…

```python
logger.info("ğŸ”‘ TokenManager ì‹±ê¸€í†¤ ì´ˆê¸°í™” ì™„ë£Œ")
logger.debug(f"ê¸°ì¡´ í† í° ì‚¬ìš© (ìœ íš¨ì‹œê°„: {remaining/3600:.1f}ì‹œê°„)")
logger.info("ğŸ”‘ Access Token ê°±ì‹  ì¤‘...")
logger.info(f"âœ… Access Token ë°œê¸‰ ì™„ë£Œ (ë§Œë£Œ: {token_expires_at})")
```

## í–¥í›„ ê°œì„  ê³„íš

### 1. Redis ê¸°ë°˜ í† í° ìºì‹±
- ì• í”Œë¦¬ì¼€ì´ì…˜ ì¬ì‹œì‘ ì‹œì—ë„ í† í° ìœ ì§€
- ë©€í‹° ì¸ìŠ¤í„´ìŠ¤ í™˜ê²½ ì§€ì›

### 2. Token ëª¨ë‹ˆí„°ë§
- í† í° ë§Œë£Œ ì•Œë¦¼ (Slack/Email)
- Grafana ëŒ€ì‹œë³´ë“œ í†µí•©

### 3. ë©€í‹° í”„ë¡œì„¸ìŠ¤ ì§€ì›
- í˜„ì¬: ë‹¨ì¼ í”„ë¡œì„¸ìŠ¤ë§Œ ì§€ì›
- ëª©í‘œ: ì—¬ëŸ¬ í”„ë¡œì„¸ìŠ¤ ê°„ í† í° ê³µìœ  (Redis/Memcached)

## ì‚¬ìš© ì˜ˆì‹œ

### ê¸°ë³¸ ì‚¬ìš©ë²•

```python
from backend.crawlers.kis_client import get_kis_client

# ì²« ë²ˆì§¸ í´ë¼ì´ì–¸íŠ¸ (í† í° ë°œê¸‰)
client1 = await get_kis_client()
result1 = await client1.get_current_price("005930")

# ë‘ ë²ˆì§¸ í´ë¼ì´ì–¸íŠ¸ (í† í° ì¬ì‚¬ìš©)
client2 = await get_kis_client()
result2 = await client2.get_current_price("000660")

# ëª¨ë‘ ê°™ì€ í† í° ì‚¬ìš©
assert client1.token_manager is client2.token_manager  # True
```

### ì¼ë´‰ ìˆ˜ì§‘ ì˜ˆì‹œ

```python
from backend.crawlers.kis_daily_crawler import get_kis_daily_crawler

# í¬ë¡¤ëŸ¬ ìƒì„± (í† í° ìë™ ê³µìœ )
crawler = get_kis_daily_crawler()

# ì—¬ëŸ¬ ì¢…ëª© ìˆ˜ì§‘ (ëª¨ë‘ ê°™ì€ í† í° ì‚¬ìš©)
for stock_code in ["005930", "000660", "035420"]:
    result = await crawler.collect_stock(stock_code, days=30, db=db)
    print(f"{stock_code}: {result['count']}ê±´ ìˆ˜ì§‘")
```

## ì°¸ê³  ìë£Œ

- **ì½”ë“œ**: `backend/crawlers/kis_client.py`
- **í…ŒìŠ¤íŠ¸**:
  - `scripts/test_token_singleton.py`
  - `scripts/test_token_reuse.py`
  - `scripts/test_kis_daily_collector.py`
- **ë¬¸ì„œ**: `docs/stories/in-progress/STORY-003.2-DAILY-PRICE-COLLECTOR.md`

## ê´€ë ¨ ì´ìŠˆ

- **User Request**: "í† í° ë°œê¸‰ ì•„í‚¤í…ì²˜ê°€ ì–´ë–»ê²Œ ë˜ê³  ìˆëŠ”ê±°ì•¼? í† í°ì€ 24ì‹œê°„ì— 1ë²ˆ ë°œê¸‰ë˜ê³  ê·¸ê±¸ ê³µìœ í•˜ê²Œ í•˜ê³  24ì‹œê°„ë§ˆë‹¤ ê°±ì‹ í•˜ê²Œ í•´ì•¼ í•  ê±° ê°™ì€ë°"
- **í•´ê²°**: Singleton pattern êµ¬í˜„ â†’ í† í° 1íšŒ ë°œê¸‰ í›„ 24ì‹œê°„ ê³µìœ  â†’ Rate Limit íšŒí”¼ ì„±ê³µ
